syntax = "proto3";

package sorting.v1;

service MasterService {
  rpc RegisterWorker(WorkerHello) returns (RegisterReply);
  rpc SendSample(SampleChunk) returns (SampleAck);
  rpc NotifyShuffleDone(ShuffleDone) returns (ShuffleDoneAck);
}

service WorkerService {
  rpc ReceivePartitionPlan(PartitionPlanMsg) returns (PartitionAck);
  rpc ReceivePartitionChunk(PartitionChunk) returns (PartitionChunkAck);
  rpc StartMerge(StartMergeMsg) returns (StartMergeAck);
}

message WorkerHello {
  string workerId = 1;
  string host     = 2;
  int32 port      = 3;
}

message RegisterReply {
  bool ok = 1;
  string assignedId = 2;
}

message SampleChunk {
  string workerId = 1;
  bytes  data     = 2;
}

message SampleAck {
  bool ok = 1;
}

message WorkerEndpoint {
  string workerId = 1;
  string host     = 2;
  int32  port     = 3;
}

message PartitionPlanMsg {
  repeated bytes pivotKeys = 1;
  repeated WorkerEndpoint endpoints = 2;
}

message PartitionAck {
  bool ok = 1;
}

message PartitionChunk {
  string fromWorkerId = 1;
  int32  partitionIdx = 2;
  bytes  data         = 3;
}

message PartitionChunkAck {
  bool ok = 1;
}

message ShuffleDone {
  string workerId = 1;
}

message ShuffleDoneAck {
  bool ok = 1;
}

message StartMergeMsg {
}

message StartMergeAck {
  bool ok = 1;
}